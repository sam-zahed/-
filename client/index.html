<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ - Smart Assistant</title>

    <!-- Accessibility Meta -->
    <meta name="description" content="Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù„Ù„Ù…ÙƒÙÙˆÙÙŠÙ† - ÙŠØªÙƒÙ„Ù… Ù…Ø¹Ùƒ ÙˆÙŠÙÙ‡Ù… Ø£ÙˆØ§Ù…Ø±Ùƒ">

    <style>
        :root {
            --primary: #6366f1;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --dark: #1e1b4b;
            --light: #f8fafc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(180deg, var(--dark) 0%, #312e81 100%);
            color: var(--light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            overflow: hidden;
        }

        /* === Ø§Ù„Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ - Ø§Ù„Ø´Ø§Ø´Ø© ÙƒÙ„Ù‡Ø§ === */
        #main-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        #main-button:active {
            background: rgba(255, 255, 255, 0.1);
        }

        #main-button.listening {
            background: linear-gradient(180deg, #dc2626 0%, #991b1b 100%);
            animation: pulse-bg 1.5s infinite;
        }

        @keyframes pulse-bg {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }
        }

        /* === Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† === */
        #mic-icon {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }

        #main-button.listening #mic-icon {
            animation: pulse 1s infinite;
            background: var(--danger);
            color: white;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        /* === Ø§Ù„Ù†ØµÙˆØµ === */
        #status-text {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            max-width: 90%;
            line-height: 1.4;
        }

        #instruction-text {
            font-size: 1.2rem;
            opacity: 0.8;
            text-align: center;
            max-width: 80%;
        }

        /* === Ø´Ø±ÙŠØ· Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø³Ø±ÙŠØ¹Ø© === */
        #quick-commands {
            display: flex;
            gap: 10px;
            padding: 15px;
            overflow-x: auto;
            background: rgba(0, 0, 0, 0.3);
            -webkit-overflow-scrolling: touch;
        }

        .quick-btn {
            flex-shrink: 0;
            padding: 15px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-btn:active {
            transform: scale(0.95);
        }

        .quick-btn.primary {
            background: var(--primary);
            color: white;
        }

        .quick-btn.warning {
            background: var(--warning);
            color: black;
        }

        .quick-btn.success {
            background: var(--success);
            color: white;
        }

        .quick-btn.danger {
            background: var(--danger);
            color: white;
        }

        /* === Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙƒØ´Ù === */
        #results-panel {
            position: fixed;
            bottom: 80px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 15px;
            padding: 15px;
            max-height: 40vh;
            overflow-y: auto;
            display: none;
            backdrop-filter: blur(10px);
        }

        #results-panel.show {
            display: block;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 1.1rem;
        }

        .result-item.danger {
            background: var(--danger);
            animation: blink 0.5s 3;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* === ÙˆØ¶Ø¹ Ø§Ù„ØµÙ…Øª === */
        #quiet-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: var(--warning);
            color: black;
            padding: 10px 20px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            display: none;
        }

        #quiet-indicator.show {
            display: block;
        }

        /* === Ø¹Ù†Ø§ØµØ± Ù…Ø®ÙÙŠØ© === */
        video,
        canvas {
            display: none;
        }

        /* === Ø´Ø§Ø´Ø© Ø§Ù„Ù„ØºØ© === */
        #lang-screen {
            position: fixed;
            inset: 0;
            background: var(--dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #lang-screen h1 {
            font-size: 1.8rem;
            margin-bottom: 40px;
            text-align: center;
            padding: 0 20px;
        }

        .lang-option {
            width: 80%;
            max-width: 300px;
            padding: 20px;
            margin: 10px;
            font-size: 1.4rem;
            border: none;
            border-radius: 15px;
            background: white;
            color: var(--dark);
            cursor: pointer;
            font-weight: bold;
        }

        .lang-option:active {
            transform: scale(0.98);
        }

        /* === ÙˆØ¶Ø¹ÙŠØ© Ø§Ù„Ø¥ÙƒØ³Ø³Ø¨Ù„ØªÙŠ === */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
    </style>
</head>

<body>
    <!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ© -->
    <div id="lang-screen" role="dialog" aria-label="Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©">
        <h1>Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©<br>Select Language<br>VÃ¦lg Sprog</h1>
        <button class="lang-option" onclick="selectLang('ar')">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
        <button class="lang-option" onclick="selectLang('en')">ğŸ‡¬ğŸ‡§ English</button>
        <button class="lang-option" onclick="selectLang('da')">ğŸ‡©ğŸ‡° Dansk</button>
    </div>

    <!-- Ù…Ø¤Ø´Ø± ÙˆØ¶Ø¹ Ø§Ù„ØµÙ…Øª -->
    <div id="quiet-indicator" role="status" aria-live="polite">
        ğŸ”‡ ÙˆØ¶Ø¹ Ø§Ù„ØµÙ…Øª - ÙÙ‚Ø· Ø§Ù„Ø£Ø®Ø·Ø§Ø±
    </div>

    <!-- Ø§Ù„Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="main-button" role="button" tabindex="0" aria-label="Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ø¯Ø« Ù…Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯" onclick="handleMainTap()">

        <div id="mic-icon" aria-hidden="true">ğŸ¤</div>
        <div id="status-text">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„ØªØ­Ø¯Ø«</div>
        <div id="instruction-text">Ø³Ø£Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ù…Ø¹Ø±ÙØ© Ù…Ø§ Ø­ÙˆÙ„Ùƒ</div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
    <div id="results-panel" role="region" aria-label="Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙƒØ´Ù" aria-live="polite"></div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø³Ø±ÙŠØ¹Ø© -->
    <div id="quick-commands" role="toolbar" aria-label="Ø£ÙˆØ§Ù…Ø± Ø³Ø±ÙŠØ¹Ø©">
        <button class="quick-btn primary" onclick="quickCommand('describe')" aria-label="ÙˆØµÙ Ø§Ù„Ù…Ø´Ù‡Ø¯">
            ğŸ‘ï¸ Ù…Ø§Ø°Ø§ Ø£Ù…Ø§Ù…ÙŠ
        </button>
        <button class="quick-btn success" onclick="quickCommand('read')" aria-label="Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ">
            ğŸ“– Ø§Ù‚Ø±Ø£
        </button>
        <button class="quick-btn warning" onclick="quickCommand('quiet')" aria-label="ÙˆØ¶Ø¹ Ø§Ù„ØµÙ…Øª">
            ğŸ”‡ Ø§Ø³ÙƒØª
        </button>
        <button class="quick-btn danger" onclick="quickCommand('scan')" aria-label="Ù…Ø³Ø­ ÙƒØ§Ù…Ù„">
            ğŸ”„ Ù…Ø³Ø­ ÙƒØ§Ù…Ù„
        </button>
    </div>

    <!-- Ø¹Ù†Ø§ØµØ± Ù…Ø®ÙÙŠØ© -->
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <script>
        // === Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ===
        let lang = 'ar';
        let isListening = false;
        let isQuietMode = false;
        let isRunning = false;
        let stream = null;
        let analyzeInterval = null;
        let mediaRecorder = null;
        let audioChunks = [];

        const synth = window.speechSynthesis;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // === ØªØ±Ø¬Ù…Ø§Øª ===
        const texts = {
            ar: {
                tapToSpeak: 'Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„ØªØ­Ø¯Ø«',
                listening: 'Ø£ØªØ­Ø¯Ø« Ù…Ø¹Ùƒ...',
                analyzing: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...',
                quietOn: 'ÙˆØ¶Ø¹ Ø§Ù„ØµÙ…Øª Ù†Ø´Ø·',
                quietOff: 'Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…ÙØ¹Ù„Ø©',
                noCamera: 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§',
                welcome: 'Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØªØ­Ø¯Ø« Ù…Ø¹ÙŠ',
                help: 'Ø³Ø£Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ù…Ø¹Ø±ÙØ© Ù…Ø§ Ø­ÙˆÙ„Ùƒ',
                nothing: 'Ù„Ø§ Ø£Ø±Ù‰ Ø´ÙŠØ¦Ø§Ù‹ ÙˆØ§Ø¶Ø­Ø§Ù‹',
                describe: 'Ù…Ø§Ø°Ø§ Ø£Ù…Ø§Ù…ÙŠ',
                read: 'Ø§Ù‚Ø±Ø£',
                quiet: 'Ø§Ø³ÙƒØª',
                scan: 'Ù…Ø³Ø­ ÙƒØ§Ù…Ù„'
            },
            en: {
                tapToSpeak: 'Tap here to speak',
                listening: 'Listening...',
                analyzing: 'Analyzing...',
                quietOn: 'Quiet mode on',
                quietOff: 'Alerts enabled',
                noCamera: 'Cannot access camera',
                welcome: 'Hello, I am your smart assistant. Tap the screen and talk to me',
                help: 'I will help you know what is around you',
                nothing: 'I do not see anything clear',
                describe: 'What is in front',
                read: 'Read text',
                quiet: 'Quiet',
                scan: 'Full scan'
            },
            da: {
                tapToSpeak: 'Tryk her for at tale',
                listening: 'Lytter...',
                analyzing: 'Analyserer...',
                quietOn: 'Stilletilstand aktiv',
                quietOff: 'Advarsler aktiveret',
                noCamera: 'Kan ikke fÃ¥ adgang til kamera',
                welcome: 'Hej, jeg er din smarte assistent. Tryk pÃ¥ skÃ¦rmen og tal til mig',
                help: 'Jeg hjÃ¦lper dig med at vide hvad der er omkring dig',
                nothing: 'Jeg kan ikke se noget klart',
                describe: 'Hvad er foran mig',
                read: 'LÃ¦s tekst',
                quiet: 'Stille',
                scan: 'Fuld scanning'
            }
        };

        function t(key) {
            return texts[lang][key] || texts['ar'][key];
        }

        // === Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ© ===
        function selectLang(selectedLang) {
            lang = selectedLang;
            document.getElementById('lang-screen').style.display = 'none';
            document.body.dir = lang === 'ar' ? 'rtl' : 'ltr';

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØµÙˆØµ
            document.getElementById('status-text').textContent = t('tapToSpeak');
            document.getElementById('instruction-text').textContent = t('help');

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            const btns = document.querySelectorAll('.quick-btn');
            btns[0].innerHTML = 'ğŸ‘ï¸ ' + t('describe');
            btns[1].innerHTML = 'ğŸ“– ' + t('read');
            btns[2].innerHTML = 'ğŸ”‡ ' + t('quiet');
            btns[3].innerHTML = 'ğŸ”„ ' + t('scan');

            // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            startCamera().then(() => {
                speak(t('welcome'));
                // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                startAutoAnalysis();
            });
        }

        // === Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ===
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: 640, height: 480 }
                });
                video.srcObject = stream;
                canvas.width = 640;
                canvas.height = 480;
                return true;
            } catch (e) {
                speak(t('noCamera'));
                return false;
            }
        }

        function captureFrame() {
            if (!video.srcObject || video.readyState < 2) {
                return null;
            }
            try {
                ctx.drawImage(video, 0, 0, 640, 480);
                return canvas.toDataURL('image/jpeg', 0.7);
            } catch (e) {
                console.error("Capture frame error:", e);
                return null;
            }
        }

        // === Ø§Ù„Ù†Ø·Ù‚ ===
        function speak(text, force = false) {
            if (!text) return;
            if (isQuietMode && !force) return;

            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);

            const voices = synth.getVoices();
            let voice = voices.find(v => v.lang.includes(lang));
            if (voice) utterance.voice = voice;

            utterance.rate = 0.9;
            synth.speak(utterance);
        }

        // === Ø§Ù„Ø¶ØºØ· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ===
        async function handleMainTap() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        // === Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ===
        async function startListening() {
            const mainBtn = document.getElementById('main-button');
            const statusText = document.getElementById('status-text');
            const micIcon = document.getElementById('mic-icon');

            try {
                const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(audioStream);
                audioChunks = [];

                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = processVoiceCommand;

                mediaRecorder.start();
                isListening = true;

                mainBtn.classList.add('listening');
                statusText.textContent = t('listening');
                micIcon.textContent = 'ğŸ”´';

                // Ø¥ÙŠÙ‚Ø§Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
                setTimeout(() => {
                    if (isListening) stopListening();
                }, 5000);

            } catch (e) {
                speak('Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ØºÙŠØ± Ù…ØªØ§Ø­');
            }
        }

        // === Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ===
        function stopListening() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }

            isListening = false;

            const mainBtn = document.getElementById('main-button');
            const statusText = document.getElementById('status-text');
            const micIcon = document.getElementById('mic-icon');

            mainBtn.classList.remove('listening');
            statusText.textContent = t('analyzing');
            micIcon.textContent = 'ğŸ¤';
        }

        // === Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ù…Ø± Ø§Ù„ØµÙˆØªÙŠ ===
        async function processVoiceCommand() {
            if (audioChunks.length === 0) return;

            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const imageBase64 = captureFrame();

            const formData = new FormData();
            formData.append('audio', audioBlob, 'voice.wav');
            formData.append('image', imageBase64);

            try {
                const res = await fetch('/assistant/chat', {
                    method: 'POST',
                    body: formData
                });

                // Ø§Ù„ØµÙˆØª Ù…Ø¨Ø§Ø´Ø±Ø©
                if (res.headers.get('content-type')?.includes('audio')) {
                    const audioData = await res.blob();
                    const audio = new Audio(URL.createObjectURL(audioData));
                    audio.play();

                    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±
                    const responseText = res.headers.get('X-Response-Text') || '';
                    document.getElementById('status-text').textContent =
                        decodeURIComponent(responseText) || t('tapToSpeak');
                } else {
                    const data = await res.json();
                    document.getElementById('status-text').textContent = data.text || t('tapToSpeak');
                    speak(data.text);
                }

            } catch (e) {
                console.error('Error:', e);
                speak('Ø®Ø·Ø£: ' + e.message);
                document.getElementById('status-text').textContent = 'Ø®Ø·Ø£: ' + e.message;
            }
        }

        // === Ø£ÙˆØ§Ù…Ø± Ø³Ø±ÙŠØ¹Ø© ===
        async function quickCommand(cmd) {
            const imageBase64 = captureFrame();

            if (cmd === 'quiet') {
                isQuietMode = !isQuietMode;
                document.getElementById('quiet-indicator').classList.toggle('show', isQuietMode);
                speak(isQuietMode ? t('quietOn') : t('quietOff'), true);

                // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø®Ø§Ø¯Ù…
                fetch('/assistant/mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: isQuietMode ? 'quiet' : 'normal' })
                });
                return;
            }

            document.getElementById('status-text').textContent = t('analyzing');

            let cmdText = '';
            switch (cmd) {
                case 'describe': cmdText = 'Ù…Ø§Ø°Ø§ Ø£Ù…Ø§Ù…ÙŠØŸ'; break;
                case 'read': cmdText = 'Ø§Ù‚Ø±Ø£'; break;
                case 'scan': cmdText = 'Ø¯ÙˆØ± Ø­ÙˆÙ„ÙŠ'; break;
            }

            try {
                const res = await fetch('/assistant/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: cmdText, image_b64: imageBase64 })
                });

                const data = await res.json();
                document.getElementById('status-text').textContent = data.text || t('nothing');
                speak(data.text);

            } catch (e) {
                console.error(e);
                speak('Ø®Ø·Ø£: ' + e.message);
                document.getElementById('status-text').textContent = 'Ø®Ø·Ø£: ' + e.message;
            }
        }

        // === Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ===
        function startAutoAnalysis() {
            if (analyzeInterval) clearInterval(analyzeInterval);

            analyzeInterval = setInterval(async () => {
                if (isListening) return; // Ù„Ø§ ØªØ­Ù„Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹

                try {
                    const imageBase64 = captureFrame();

                    const res = await fetch('/assistant/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image_b64: imageBase64 })
                    });

                    const data = await res.json();

                    // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙ‚Ø·
                    if (data.should_speak && data.speak_message) {
                        document.getElementById('status-text').textContent = data.speak_message;
                        speak(data.speak_message);

                        // Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„Ø®Ø·Ø±
                        if (data.alerts?.some(a => a.alert_priority <= 2)) {
                            navigator.vibrate?.([300, 100, 300]);
                        }
                    }

                    // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    updateResultsPanel(data.alerts || []);

                } catch (e) {
                    console.error('Analysis error:', e);
                }

            }, 4000); // ÙƒÙ„ 4 Ø«ÙˆØ§Ù†ÙŠ
        }

        // === ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ===
        function updateResultsPanel(alerts) {
            const panel = document.getElementById('results-panel');

            if (alerts.length === 0) {
                panel.classList.remove('show');
                return;
            }

            panel.classList.add('show');
            panel.innerHTML = alerts.slice(0, 5).map(alert => `
                <div class="result-item ${alert.alert_priority <= 2 ? 'danger' : ''}">
                    <span>${alert.class_ar || alert.class}</span>
                    <span>${alert.distance_m?.toFixed(1) || '?'} Ù…</span>
                </div>
            `).join('');
        }

        // === ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª ===
        speechSynthesis.onvoiceschanged = () => { };

        // === Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ (Ù„Ù„Ø¥ÙƒØ³Ø³Ø¨Ù„ØªÙŠ) ===
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                handleMainTap();
            } else if (e.key === 'q') {
                quickCommand('quiet');
            } else if (e.key === 'd') {
                quickCommand('describe');
            }
        });
    </script>
</body>

</html>